{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","context","cubismHeight","anHour","aDay","aWeek","aMonth","cubismContainer","find","get","events","on","render","renderingCompleted","length","firstSeries","datapoints","earliest","latest","seriesLength","span","size","Math","floor","d3","select","node","getBoundingClientRect","width","step","serverDelay","Date","now","cubismTimestamps","ts","push","innerHTML","cubism","stop","cubismData","map","series","seriesIndex","convertDataToCubism","forEach","d","override","height","setElementHeight","selectAll","enter","append","attr","each","scale","time","hour","count","minute","day","call","axis","ticks","orient","rule","div","fn","i","thisHorizon","extent","low","high","undefined","formatFn","kbn","valueFormats","format","horizon","colors","negative","concat","positive","c","rgb","value","isNaN","allHorizons","insert","timestamps","getMatchingSeriesOverride","metric","start","callback","dataPoints","values","point","pointIndex","_","chain","tsIndex","nextPoint","lastPointIndex","nextTs","filter","summaryType","sumValues","minValue","maxValue","averageValues","target","reduce","a","b","sum","max","min","row","isString","parseInt","replace","title","style","minHeight","e","formatter","label","slice","fontSize","color","round","percent"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\nimport cubism from './cubism/index';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel, context, cubismHeight;\n  const anHour = 60 * 60 * 1000;\n  const aDay = 24 * anHour;\n  const aWeek = 7 * aDay;\n  const aMonth = 4 * aWeek;\n\n  var cubismContainer = elem.find('.cubism-panel').get(0);\n\n  ctrl.events.on('render', function () {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!(ctrl.data && ctrl.data.length > 0)) {\n      return;\n    }\n\n    var firstSeries = ctrl.data[0].datapoints;\n    var earliest = firstSeries[0][1];\n    var latest = firstSeries[firstSeries.length - 1][1];\n    var seriesLength = firstSeries.length;\n    var span = latest - earliest;\n    var size = Math.floor(d3.select(cubismContainer)\n      .node()\n      .getBoundingClientRect()\n      .width);\n    var step = Math.floor((latest - earliest) / (size));\n    var serverDelay = Date.now() - latest;\n\n    var cubismTimestamps = [];\n    for (var ts = earliest; ts <= latest; ts = ts + step) {\n      cubismTimestamps.push(ts);\n    }\n\n    /*\n     First we need the server delay to be at the right place (now - latest)\n     */\n\n    cubismContainer.innerHTML = \"\";\n    context = cubism.context()\n      .serverDelay(serverDelay)\n      .step(step)\n      .size(size)\n      .stop();\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    var cubismData = data\n      .map(function (series, seriesIndex) {\n        return convertDataToCubism(series, seriesIndex, cubismTimestamps);\n      });\n\n    cubismHeight = 0;\n\n    cubismData\n      .forEach(function (d) {\n        cubismHeight = cubismHeight + d.override.height;\n      });\n\n    cubismHeight = cubismHeight + 60;\n\n    if (setElementHeight()) {\n      d3.select(cubismContainer)\n        .selectAll(\".axis\")\n        .data([\"top\", \"bottom\"])\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", function (d) {\n          return d + \" axis\"\n        })\n        .each(function (d) {\n          var scale = d3.time.hour;\n          var count = 6;\n          if (span < 2 * anHour) {\n            var scale = d3.time.minute;\n            var count = 15;\n          } else if (span < 12 * anHour) {\n            var scale = d3.time.hour;\n            var count = 1;\n          } else if (span < aDay) {\n            var scale = d3.time.hour;\n            var count = 3;\n          } else if (span < 2 * aDay) {\n            var scale = d3.time.hour;\n            var count = 6;\n          } else if (span < 2 * aWeek) {\n            var scale = d3.time.day;\n            var count = 1;\n          } else if (span < 2 * aMonth) {\n            var scale = d3.time.day;\n            var count = 2;\n          }\n          d3.select(this)\n            .call(context.axis().ticks(scale, count).orient(d))\n        });\n\n      d3.select(cubismContainer)\n        .append(\"div\")\n        .attr(\"class\", \"rule\")\n        .call(context.rule());\n\n      d3.select(cubismContainer)\n        .call(\n          function (div) {\n            function fn(d, i) {\n              var thisHorizon = this;\n              var extent = null;\n              if (d.override.extent.low != null && d.override.extent.high != null && d.override.extent.low != undefined && d.override.extent.high != undefined) {\n                extent = [d.override.extent.low, d.override.extent.high];\n              }\n              var formatFn = kbn.valueFormats[d.override.format];\n              d3.select(thisHorizon)\n                .call(\n                  context.horizon()\n                    .colors(d.override.colors.negative.concat(d.override.colors.positive)\n                      .map(function (c) {\n                        return c.rgb;\n                      }))\n                    .height(d.override.height)\n                    .format(function (value) {\n                      if (isNaN(value) || value == null || value == undefined) {\n                        return \"\";\n                      } else {\n                        return formatFn(value);\n                      }\n                    })\n                    .extent(extent)\n                );\n            }\n\n            var allHorizons = div\n              .selectAll('.horizon')\n              .data(cubismData);\n\n            allHorizons\n              .each(fn);\n\n            allHorizons\n              .enter()\n              .insert(\"div\", \".bottom\")\n              .attr(\"class\", \"horizon\")\n              .each(fn);\n          }\n        );\n\n    }\n  }\n\n  function convertDataToCubism(series, seriesIndex, timestamps) {\n    var override = ctrl.getMatchingSeriesOverride(series);\n    var metric = context.metric(function (start, stop, step, callback) {\n      var dataPoints = series.datapoints;\n      var values = [];\n      if (timestamps.length == dataPoints.length) {\n        values = dataPoints\n          .map(function (point) {\n            return point[0];\n          });\n      } else if (timestamps.length > dataPoints.length) {\n        var pointIndex = 0;\n        values = _.chain(timestamps)\n          .map(\n            function (ts, tsIndex) {\n              var point = dataPoints[pointIndex];\n              var nextPoint = null;\n              if (pointIndex + 1 < dataPoints.length) {\n                nextPoint = dataPoints[pointIndex + 1];\n              }\n              if (nextPoint == null || ts < nextPoint[1]) {\n                return point[0];\n              } else {\n                pointIndex++;\n                return nextPoint[0];\n              }\n            }\n          )\n          .value();\n      } else {\n        var lastPointIndex = 0;\n        values = _.chain(timestamps)\n          .map(\n            function (ts, tsIndex) {\n              var nextTs = null;\n              if (tsIndex + 1 < timestamps.length) {\n                nextTs = timestamps[tsIndex + 1];\n              }\n              var values = dataPoints\n                .filter(function (point) {\n                  return point[1] >= ts && (nextTs == null || point[1] < nextTs);\n                })\n                .map(function (point) {\n                  return point[0];\n                });\n              if (override.summaryType == \"sum\") {\n                return sumValues(values)\n              } else if (override.summaryType == \"min\") {\n                return minValue(values)\n              } else if (override.summaryType == \"max\") {\n                return maxValue(values)\n              } else {\n                return averageValues(values)\n              }\n            }\n          )\n          .value();\n      }\n      callback(null, values)\n    }, series.target);\n    metric.override = override;\n    return metric;\n  }\n\n  function sumValues(values) {\n    return values.reduce(function (a, b) {\n      return a + b;\n    }, 0);\n  }\n\n  function averageValues(values) {\n    var sum = values.reduce(function (a, b) {\n      return a + b;\n    }, 0);\n    return sum / values.length;\n  }\n\n  function maxValue(values) {\n    return values.reduce(function (a, b) {\n      return Math.max(a, b);\n    }, 0);\n  }\n\n  function minValue(values) {\n    return values.reduce(function (a, b) {\n      return Math.min(a, b);\n    }, 0);\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      height = Math.max(height, cubismHeight);\n\n      cubismContainer.style.height = height + 'px';\n      cubismContainer.style.minHeight = height + 'px';\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    return \"<div style='font-size:\" + ctrl.panel.fontSize +\n      \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label +\n      \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\n  }\n\n}\n"]}