{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\nimport cubism from './cubism/index';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel, context, cubismHeight;\n  const anHour = 60 * 60 * 1000;\n  const aDay = 24 * anHour;\n  const aWeek = 7 * aDay;\n  const aMonth = 4 * aWeek;\n\n  var cubismContainer = elem.find('.cubism-panel').get(0);\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!(ctrl.data && ctrl.data.length > 0)) {\n      return;\n    }\n\n    var firstSeries = ctrl.data[0].datapoints;\n    var earliest = firstSeries[0][1];\n    var latest = firstSeries[firstSeries.length - 1][1];\n    var seriesLength = firstSeries.length;\n    var span = latest - earliest;\n    var size = Math.floor(d3.select(cubismContainer)\n      .node()\n      .getBoundingClientRect()\n      .width);\n    var step = Math.floor((latest - earliest) / (size));\n    var serverDelay = Date.now() - latest;\n\n    var cubismTimestamps = [];\n    for (var ts = earliest; ts <= latest; ts = ts + step) {\n      cubismTimestamps.push(ts);\n    }\n\n    /*\n    First we need the server delay to be at the right place (now - latest)\n     */\n\n    cubismContainer.innerHTML = \"\";\n    context = cubism.context()\n      .serverDelay(serverDelay)\n      .step(step)\n      .size(size)\n      .stop();\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    var cubismData = data\n      .map(function (series, seriesIndex) {\n        return convertDataToCubism(series, seriesIndex, cubismTimestamps);\n      });\n\n    cubismHeight = 0;\n\n    cubismData\n      .forEach(function (d) {\n        cubismHeight = cubismHeight + d.override.height;\n      });\n\n    cubismHeight = cubismHeight + 60;\n\n    if (setElementHeight()) {\n      d3.select(cubismContainer)\n        .selectAll(\".axis\")\n        .data([\"top\", \"bottom\"])\n        .enter()\n        .append(\"div\")\n        .attr(\"class\", function(d) {\n          return d + \" axis\"\n        })\n        .each(function(d) {\n          var scale = d3.time.hour;\n          var count = 6;\n          if (span < 2 * anHour) {\n            var scale = d3.time.minute;\n            var count = 15;\n          } else if (span < 12 * anHour) {\n            var scale = d3.time.hour;\n            var count = 1;\n          } else if (span < aDay) {\n            var scale = d3.time.hour;\n            var count = 3;\n          } else if (span < 2 * aDay) {\n            var scale = d3.time.hour;\n            var count = 6;\n          } else if (span < 2 * aWeek) {\n            var scale = d3.time.day;\n            var count = 1;\n          } else if (span < 2 * aMonth) {\n            var scale = d3.time.day;\n            var count = 2;\n          }\n          d3.select(this)\n            .call(context.axis().ticks(scale, count).orient(d))\n        });\n\n      d3.select(cubismContainer)\n        .append(\"div\")\n        .attr(\"class\", \"rule\")\n        .call(context.rule());\n\n      d3.select(cubismContainer)\n        .call(\n          function (div) {\n            function fn(d, i) {\n              var thisHorizon = this;\n              var extent = null;\n              if (d.override.extent.low != null && d.override.extent.high != null && d.override.extent.low != undefined && d.override.extent.high != undefined) {\n                extent = [d.override.extent.low, d.override.extent.high];\n              }\n              d3.select(thisHorizon)\n                .call(\n                  context.horizon()\n                    .colors(d.override.colors.negative.concat(d.override.colors.positive)\n                      .map(function (c) {\n                        return c.rgb;\n                      }))\n                    .height(d.override.height)\n                    .format(kbn.valueFormats[d.override.format])\n                    .extent(extent)\n                );\n            }\n\n            var allHorizons = div\n              .selectAll('.horizon')\n              .data(cubismData);\n\n            allHorizons\n              .each(fn);\n\n            allHorizons\n              .enter()\n              .insert(\"div\", \".bottom\")\n              .attr(\"class\", \"horizon\")\n              .each(fn);\n          }\n        );\n\n    }\n  }\n\n  function convertDataToCubism(series, seriesIndex, timestamps) {\n    var metric = context.metric(function(start, stop, step, callback) {\n      var dataPoints = series.datapoints;\n      var values = [];\n      if (timestamps.length == dataPoints.length) {\n        values = dataPoints\n          .map(function (point) {\n            return point[0];\n          });\n      } else if (timestamps.length > dataPoints.length) {\n        var pointIndex = 0;\n        values = _.chain(timestamps)\n          .map(\n            function (ts, tsIndex) {\n              var point = dataPoints[pointIndex];\n              var nextPoint = null;\n              if (pointIndex + 1 < dataPoints.length) {\n                nextPoint = dataPoints[pointIndex + 1];\n              }\n              if (nextPoint == null || ts < nextPoint[1]) {\n                return point[0];\n              } else {\n                pointIndex++;\n                return nextPoint[0];\n              }\n            }\n          )\n          .value();\n      } else {\n        var lastPointIndex = 0;\n        values = _.chain(timestamps)\n          .map(\n            function (ts, tsIndex) {\n              var nextTs = null;\n              if (tsIndex + 1 < timestamps.length) {\n                nextTs = timestamps[tsIndex + 1];\n              }\n              var values = dataPoints\n                .filter(function (point) {\n                  return point[1] >= ts && (nextTs == null || point[1] < nextTs);\n                })\n                .map(function (point) {\n                  return point[0];\n                });\n              return averageValues(values)\n            }\n          )\n          .value();\n      }\n      callback(null, values)\n    }, series.target);\n    metric.override = ctrl.getMatchingSeriesOverride(series);\n    return metric;\n  }\n\n  function sumValues(values) {\n    return values.reduce(function(a, b) { return a + b; });\n  }\n\n  function averageValues(values) {\n    var sum = values.reduce(function(a, b) { return a + b; });\n    return sum / values.length;\n  }\n\n  function maxValue(values) {\n    return values.reduce(function(a, b) { return Math.max(a, b); })\n  }\n\n  function minValue(values) {\n    return values.reduce(function(a, b) { return Math.min(a, b); })\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      height = Math.max(height, cubismHeight);\n\n      cubismContainer.style.height = height + 'px';\n      cubismContainer.style.minHeight = height + 'px';\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    return \"<div style='font-size:\" + ctrl.panel.fontSize +\n      \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label +\n      \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\n  }\n\n}\n"]}